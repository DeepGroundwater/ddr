# Benchmark configuration for comparing DDR vs DiffRoute
# Extends standard DDR config format with DiffRoute options

defaults:
  - _self_
  - hydra: settings

# Standard DDR config (same as example_config.yaml)
mode: testing
geodataset: merit
name: benchmarks-v${oc.env:BENCHMARKS_VERSION,dev}-${geodataset}
device: 2

data_sources:
  attributes: /projects/mhpi/tbindas/ddr/data/merit_global_attributes_v2.nc
  geospatial_fabric_gpkg: /projects/mhpi/data/MERIT/raw/continent/riv_pfaf_7_MERIT_Hydro_v07_Basins_v01_bugfix1.shp
  conus_adjacency: /projects/mhpi/tbindas/ddr/data/merit_conus_adjacency.zarr
  gages_adjacency: /projects/mhpi/tbindas/ddr/data/merit_gages_conus_adjacency.zarr
  statistics: /projects/mhpi/tbindas/ddr/data/statistics
  streamflow: /projects/mhpi/tbindas/ddr/data/merit_dhbv2_UH_retrospective
  observations: /projects/mhpi/data/icechunk/usgs_daily_observations
  gages: /projects/mhpi/tbindas/ddr/references/gage_info/gages_3000.csv
  forcings: /projects/mhpi/data/icechunk/merit_forcing_conus

params:
  save_path: ./
  use_leakance: true
  parameter_ranges:
    n: [0.015, 0.25]       # Manning's roughness (KAN, static spatial)

experiment:
  batch_size: 365
  start_time: 1995/10/01
  end_time: 2010/09/30
  warmup: 3
  checkpoint: /projects/mhpi/tbindas/ddr/output/ddr-v0.5.0-merit-training/2026-02-18_21-50-33/saved_models/_ddr-v0.5.0-merit-training_epoch_7_mb_43.pt

kan:
  hidden_size: 21
  input_var_names:
    - FW
    - aridity
    - meanelevation
    - meanP
    - NDVI
    - meanslope
    - log10_uparea
    - glaciers
    - ETPOT_Hargr
    - Porosity
  num_hidden_layers: 2
  learnable_parameters:
    - q_spatial
    - top_width
    - side_slope
    - K_D_delta
    - n
    - leakance_gate
  gate_parameters:
    - leakance_gate
  grid: 50
  k: 2

cuda_lstm:
  hidden_size: 128
  num_layers: 1
  dropout: 0.4
  forcing_var_names:
    - P
    - PET
    - Temp
  learnable_parameters:
    - d_gw
  input_var_names:
    - SoilGrids1km_clay
    - aridity
    - glaciers
    - meanelevation
    - snowfall_fraction
    - NDVI
    - log10_uparea
    - SoilGrids1km_sand
    - permeability
    - Porosity

# === DiffRoute-specific configuration ===
diffroute:
  # Enable/disable DiffRoute comparison
  enabled: true

  # Impulse Response Function model
  # Options: muskingum, linear_storage, nash_cascade, pure_lag, hayami
  irf_fn: muskingum

  # Maximum delay for LTI router (number of timesteps)
  max_delay: 100

  # Timestep in days (3600/86400 = 1 hour)
  dt: 0.0416667

  # Muskingum k parameter (wave travel time through reach) in days
  # Must be in same units as dt. For stability: k >= dt / (2*(1-x))
  # k = reach_length / wave_celerity
  # 0.1042 days = 9000s = 2.5 hours (RAPID default)
  k: 0.1042

  # Muskingum x parameter (weighting factor, typically 0-0.5)
  # x=0 gives pure reservoir behavior, x=0.5 gives pure translation
  x: 0.3

# === Optional baseline comparison ===
summed_q_prime: /projects/mhpi/tbindas/ddr/output/ddr-v0.3.2.dev10+g2ffbf380e.d20260207-merit-q_prime/2026-02-07_19-50-49/summed_q_prime.zarr
